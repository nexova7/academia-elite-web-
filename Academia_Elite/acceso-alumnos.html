<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso Seguro | Academia de Conducci√≥n √âlite</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <style>
        :root {
            --red: #b71c1c;
            --gold: #c5a059;
            --dark: #050505;
            --card: rgba(17, 17, 17, 0.9);
        }

        body {
            background: radial-gradient(circle at center, #1a1a1a 0%, #050505 100%);
            color: white;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .auth-container {
            background: var(--card);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(197, 160, 89, 0.3);
            width: 100%;
            max-width: 450px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
        }

        .tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 1px solid #222;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            color: #555;
            transition: 0.3s;
            font-weight: bold;
        }

        .tab.active {
            color: var(--gold);
            border-bottom: 2px solid var(--gold);
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        .input-group {
            margin-bottom: 12px;
            position: relative;
        }

        label {
            display: block;
            font-size: 11px;
            color: var(--gold);
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        input {
            width: 100%;
            padding: 12px;
            background: #000;
            border: 1px solid #333;
            color: white;
            border-radius: 8px;
            box-sizing: border-box;
            outline: none;
        }

        input:focus {
            border-color: var(--gold);
        }

        /* Select personalizado igual que input */
        select {
            width: 100%;
            padding: 12px;
            background: #000;
            border: 1px solid #333;
            color: white;
            border-radius: 8px;
            box-sizing: border-box;
            outline: none;
            appearance: none;
        }

        .btn-action {
            width: 100%;
            padding: 14px;
            background: var(--gold);
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            color: black;
            transition: 0.3s;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(197, 160, 89, 0.4);
        }

        .btn-glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--gold);
            padding: 10px 18px;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: 0.3s;
            font-size: 13px;
        }

        .btn-glass:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .eye-icon {
            position: absolute;
            right: 12px;
            top: 32px;
            cursor: pointer;
            color: var(--gold);
            font-size: 18px;
        }

        .wa-link {
            display: block;
            text-align: center;
            color: #25D366;
            text-decoration: none;
            font-size: 12px;
            margin-top: 15px;
            font-weight: bold;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="auth-container">
        <button class="btn-glass" onclick="window.location.href='index.html'">‚Üê Volver al inicio</button>

        <div class="tabs">
            <div id="tab-login" class="tab active" onclick="switchTab('login')">Ingreso</div>
            <div id="tab-register" class="tab" onclick="switchTab('register')">Registro Estudiante</div>
        </div>

        <div id="login-form" class="form-section active">
            <h3 style="text-align:center; color: var(--gold);">IDENTIFICACI√ìN</h3>
            <div class="input-group">
                <label>Correo Electr√≥nico</label>
                <input type="email" id="logUser" placeholder="Tu correo registrado">
            </div>
            <div class="input-group">
                <label>Contrase√±a</label>
                <input type="password" id="logPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <span class="eye-icon" onclick="togglePass('logPass')">üëÅÔ∏è</span>
            </div>
            <button class="btn-action" onclick="validarIngreso()">INGRESAR üöó</button>
            <a href="#" class="wa-link" onclick="recuperarClave()">¬øOlvidaste tu contrase√±a? Solicita ayuda üì±</a>
        </div>

        <div id="register-form" class="form-section">
            <h3 style="text-align:center; color: var(--gold);">REGISTRO NUEVO</h3>
            <div class="input-group">
                <label>Nombre Completo</label>
                <input type="text" id="regFull" placeholder="Nombre y Apellidos">
            </div>
            <div class="input-group">
                <label>Correo Electr√≥nico</label>
                <input type="email" id="regMail" placeholder="correo@ejemplo.com">
            </div>
            <div class="input-group">
                <label>Categor√≠a</label>
                <select id="regCat">
                    <option value="B1">üöò B1 - Autom√≥vil Particular</option>
                    <option value="A2">üèçÔ∏è A2 - Motocicleta</option>
                    <option value="C1">üöö C1 - Servicio P√∫blico</option>
                    <option value="C2">üöõ C2 - Cami√≥n R√≠gido</option>
                </select>
            </div>
            <div class="input-group">
                <label>Contrase√±a</label>
                <input type="password" id="regPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <span class="eye-icon" onclick="togglePass('regPass')">üëÅÔ∏è</span>
            </div>
            <div class="input-group">
                <label>Repetir Contrase√±a</label>
                <input type="password" id="regPass2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <span class="eye-icon" onclick="togglePass('regPass2')">üëÅÔ∏è</span>
            </div>

            <button class="btn-action" onclick="solicitarPinWA()">1. SOLICITAR PIN AL WHATSAPP üì±</button>
            <button class="btn-action" style="background:#333; color:white;" onclick="verificarPinYRegistrar()">2.
                INGRESAR PIN Y FINALIZAR üìù</button>
        </div>
    </div>

    <script>
        // Usar instancia centralizada (js/supabase-config.js)
        const _supabase = window.supabaseInstance;
        const academiaWA = "573133482932";

        function switchTab(type) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-section').forEach(f => {
                f.classList.remove('active');
                f.style.display = 'none';
            });

            const tab = document.getElementById('tab-' + type);
            const form = type === 'login' ? document.getElementById('login-form') : document.getElementById('register-form');

            if (tab) tab.classList.add('active');
            if (form) {
                form.style.display = 'block';
                setTimeout(() => form.classList.add('active'), 10);
            }
        }

        function togglePass(id) {
            const el = document.getElementById(id);
            el.type = el.type === "password" ? "text" : "password";
        }

        async function verificarPinYRegistrar() {
            // 1. Validar PIN
            // const pinValidos = ["A123", "B123", "C123"]; // Desactivado para facilidad de uso
            const pinUser = prompt("üîê INGRESA EL C√ìDIGO DE ACTIVACI√ìN (Usa: A123):");
            if (!pinUser || pinUser.toUpperCase() !== "A123") {
                return alert("‚ùå PIN incorrecto o cancelado.");
            }

            // 2. Obtener Datos
            const email = document.getElementById('regMail').value.trim();
            const pass = document.getElementById('regPass').value;
            const pass2 = document.getElementById('regPass2').value;
            const full = document.getElementById('regFull').value.trim();
            const cat = document.getElementById('regCat').value.trim();

            // 3. Validaciones Locales
            if (pass !== pass2) return alert("‚ùå Las contrase√±as no coinciden.");
            if (pass.length < 6) return alert("‚ùå La contrase√±a debe tener al menos 6 caracteres.");
            if (!email || !full) return alert("‚ö†Ô∏è Completa todos los campos obligatorios.");

            // 4. Registro en Auth (Supabase)
            const { data: authData, error: authError } = await _supabase.auth.signUp({
                email: email,
                password: pass,
                options: {
                    data: { full_name: full } // Se guarda en metadata por si falla el trigger
                }
            });

            if (authError) return alert("Error de registro: " + authError.message);

            if (authData.user) {
                // 5. Inserci√≥n Expl√≠cita en Tabla 'alumnos' (Backup del Trigger)
                // Intentamos insertar expl√≠citamente para asegurar que la categor√≠a quede guardada
                const { error: dbError } = await _supabase.from('alumnos').insert([{
                    id: authData.user.id,
                    email: email,
                    nombre: full,
                    categoria: cat,
                    activo: true
                }]);

                if (dbError) {
                    // Si falla por duplicado (el trigger ya lo cre√≥), actualizamos la categor√≠a
                    if (dbError.code === '23505') {
                        await _supabase.from('alumnos').update({ categoria: cat, nombre: full }).eq('id', authData.user.id);
                    } else {
                        console.warn("Advertencia DB:", dbError.message);
                    }
                }

                alert("‚úÖ ¬°Cuenta Creada Exitosamente!\nYa puedes iniciar sesi√≥n.");
                switchTab('login');
            }
        }

        async function validarIngreso() {
            const email = document.getElementById('logUser').value.trim();
            const password = document.getElementById('logPass').value;

            if (!email || !password) return alert("‚ö†Ô∏è Ingresa correo y contrase√±a.");

            const { data, error } = await _supabase.auth.signInWithPassword({ email, password });

            if (error) {
                console.error("Login Error:", error);
                return alert("‚ùå Credenciales inv√°lidas.");
            }

            // Verificar que el perfil de alumno exista
            if (data.user) {
                const { data: perfil, error: perfilError } = await _supabase
                    .from('alumnos')
                    .select('nombre')
                    .eq('id', data.user.id)
                    .single();

                if (!perfil) {
                    // Si entra pero no tiene perfil, intentar crearlo al vuelo (Auto-Fix)
                    console.log("Perfil no encontrado, intentando reparar...");
                    const { error: insertError } = await _supabase.from('alumnos').insert([{
                        id: data.user.id,
                        email: email,
                        nombre: data.user.user_metadata.full_name || "Alumno",
                        categoria: 'B1' // Default si no se encuentra
                    }]);

                    if (insertError) console.error("Error reparando perfil:", insertError);
                }
            }

            window.location.href = "dashboard-alumno.html";
        }

        function solicitarPinWA() {
            window.open(`https://wa.me/${academiaWA}?text=Hola, quiero registrarme. Solicito mi PIN de activaci√≥n.`, '_blank');
        }

        function recuperarClave() {
            window.open(`https://wa.me/${academiaWA}?text=Olvid√© mi contrase√±a. Ayuda soporte.`, '_blank');
        }
    </script>
</body>

</html>