<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academia de Conducción Élite | Panel Oficial</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg: #050505;
            --glass: rgba(255, 255, 255, 0.05);
            --gold: #c5a059;
            --gold-light: #f5d76e;
            --text: #ffffff;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
        
        body {
            margin: 0;
            background: radial-gradient(circle at center, #1a1a1a 0%, #050505 100%);
            color: var(--text);
            min-height: 100vh;
        }

        /* ---------- NAVEGACIÓN ---------- */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 30px; background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px); border-bottom: 1px solid rgba(197, 160, 89, 0.3);
            position: sticky; top: 0; z-index: 1000;
        }

        nav h1 { font-size: 20px; color: var(--gold); margin: 0; letter-spacing: 1px; }

        .menu { display: flex; gap: 20px; }
        .menu a { color: #fff; text-decoration: none; font-size: 14px; font-weight: 500; transition: 0.3s; }
        .menu a:hover { color: var(--gold); }

        .hamburger { display: none; font-size: 24px; cursor: pointer; color: var(--gold); }

        /* ---------- CONTENEDORES ---------- */
        .container { max-width: 1200px; margin: auto; padding: 25px; }
        .section { display: none; animation: fadeIn 0.5s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .glass-card {
            background: var(--glass); backdrop-filter: blur(12px);
            border-radius: 20px; padding: 30px;
            border: 1px solid rgba(197, 160, 89, 0.2);
            margin-bottom: 25px;
        }

        /* ---------- GRID PRINCIPAL ---------- */
        .main-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 25px; }

        /* ---------- LICENCIA DIGITAL ---------- */
        .license-card {
            background: linear-gradient(135deg, #111, #050505);
            border: 2px solid var(--gold); border-radius: 20px; padding: 20px;
            border-left: 10px solid var(--gold); position: relative;
        }

        .photo-container { position: relative; width: 140px; height: 140px; margin: 0 auto 15px; }
        .photo-frame { width: 100%; height: 100%; border: 3px solid var(--gold); border-radius: 15px; object-fit: cover; background: #222; }
        .upload-badge {
            position: absolute; bottom: -5px; right: -5px; background: var(--gold);
            color: black; width: 35px; height: 35px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* ---------- STATS INDICADORES ---------- */
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .stat-item { background: rgba(0,0,0,0.4); padding: 10px; border-radius: 10px; text-align: center; border: 1px solid rgba(197, 160, 89, 0.1); }
        .stat-item span { display: block; font-size: 10px; color: var(--gold); font-weight: bold; text-transform: uppercase; }
        .stat-item b { font-size: 18px; }

        /* ---------- FORMULARIOS ---------- */
        .input-group { margin-bottom: 20px; position: relative; }
        label { display: block; font-size: 12px; color: var(--gold); margin-bottom: 8px; font-weight: bold; }
        input, select {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #333;
            background: rgba(255,255,255,0.05); color: #fff; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--gold); background: rgba(255,255,255,0.1); }

        .btn-gold {
            width: 100%; padding: 15px; border: none; border-radius: 10px;
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            color: #000; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(197, 160, 89, 0.4); }

        /* ---------- TRIVIA ---------- */
        .trivia-btn {
            width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px;
            background: rgba(255,255,255,0.05); border: 1px solid #444; color: #fff;
            text-align: left; cursor: pointer; transition: 0.2s;
        }
        .trivia-btn:hover { border-color: var(--gold); background: rgba(197, 160, 89, 0.1); }

        /* ---------- RESERVAS CARDS ---------- */
        .reserva-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(197, 160, 89, 0.2);
            padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex;
            justify-content: space-between; align-items: center;
        }
        .btn-cancel { background: #b22222; color: #fff; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .btn-cancel:disabled { background: #444; cursor: not-allowed; }

        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
            .menu { display: none; }
            .hamburger { display: block; }
        }
    </style>
</head>
<body>

<nav>
    <h1><i class="fas fa-steering-wheel"></i> ACADEMIA ÉLITE</h1>
    <div class="hamburger" onclick="toggleMenu()">☰</div>
    <div class="menu" id="menu">
        <a href="#" onclick="showSection('login')">INICIO</a>
        <a href="#" onclick="showSection('dashboard')">MI PANEL</a>
        <a href="#" id="btnLogOut" style="display:none" onclick="logout()">SALIR</a>
    </div>
</nav>

<div class="container">

    <div id="login" class="section active">
        <div class="glass-card" style="max-width: 450px; margin: auto;">
            <h2 style="text-align:center; color: var(--gold);">BIENVENIDO</h2>
            <div class="input-group">
                <label>Correo Electrónico</label>
                <input type="email" id="loginEmail" placeholder="ejemplo@correo.com">
            </div>
            <div class="input-group">
                <label>Contraseña</label>
                <input type="password" id="loginPass">
            </div>
            <button class="btn-gold" onclick="login()">INGRESAR AL SISTEMA</button>
            <p style="text-align:center; font-size: 13px; margin-top: 15px;">
                ¿No tienes cuenta? <a href="#" onclick="showSection('registro')" style="color:var(--gold);">Regístrate aquí</a>
            </p>
        </div>
    </div>

    <div id="registro" class="section">
        <div class="glass-card" style="max-width: 450px; margin: auto;">
            <h2 style="text-align:center; color: var(--gold);">NUEVO ALUMNO</h2>
            <div class="input-group"><label>Nombre Completo</label><input type="text" id="regNombre"></div>
            <div class="input-group"><label>Email</label><input type="email" id="regEmail"></div>
            <div class="input-group"><label>Contraseña</label><input type="password" id="regPass"></div>
            <div class="input-group"><label>PIN de Activación</label><input type="text" id="regPin" placeholder="Ej: A123"></div>
            <button class="btn-gold" onclick="registrar()">CREAR CUENTA</button>
            <button class="btn-gold" style="background:none; color:white; margin-top:10px;" onclick="showSection('login')">VOLVER</button>
        </div>
    </div>

    <div id="dashboard" class="section">
        <div class="main-grid">
            
            <div class="left-col">
                <div class="glass-card">
                    <h3 style="color:var(--gold); margin-top:0;"><i class="fas fa-calendar-check"></i> AGENDAR CLASE PRÁCTICA</h3>
                    <div class="input-group">
                        <label>Selecciona Instructor</label>
                        <select id="instructor">
                            <option value="Instructor Camilo">Instructor Camilo (Experto Moto)</option>
                            <option value="Instructora Liliana">Instructora Liliana (Seguridad Vial)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Fecha de la Clase</label>
                        <input type="date" id="fecha">
                    </div>
                    <div class="input-group">
                        <label>Horario Disponible</label>
                        <select id="hora">
                            <option value="08:00:00">08:00 AM</option>
                            <option value="10:00:00">10:00 AM</option>
                            <option value="14:00:00">02:00 PM</option>
                            <option value="16:00:00">04:00 PM</option>
                        </select>
                    </div>
                    <button class="btn-gold" onclick="reservar()">CONFIRMAR AGENDAMIENTO</button>
                </div>

                <div class="glass-card">
                    <h3 style="color:var(--gold);"><i class="fas fa-brain"></i> DESAFÍO TEÓRICO (TRIVIA)</h3>
                    <div id="trivia-box">
                        <p id="pregunta">¿Cuál es la distancia mínima de seguridad al adelantar a un ciclista?</p>
                        <button class="trivia-btn" onclick="responderTrivia(100)">A. 1.5 Metros</button>
                        <button class="trivia-btn" onclick="responderTrivia(0)">B. 0.5 Metros</button>
                    </div>
                </div>
            </div>

            <div class="right-col">
                <div class="license-card">
                    <div class="photo-container">
                        <img id="currentAvatar" src="1.jpeg" class="photo-frame">
                        <label for="fileInput" class="upload-badge"><i class="fas fa-camera"></i></label>
                        <input type="file" id="fileInput" hidden accept="image/*" onchange="subirFoto(this)">
                    </div>
                    <h4 id="dispNombre" style="text-align:center; margin: 10px 0; letter-spacing: 1px;">ALUMNO ÉLITE</h4>
                    <p style="text-align:center; font-size: 11px; opacity: 0.6;">LICENCIA DE CONDUCCIÓN INTERNA</p>
                    
                    <div class="stats-row">
                        <div class="stat-item"><span id="lblClases">Clases</span><b id="stat-clases">0/20</b></div>
                        <div class="stat-item"><span>Trivia</span><b id="stat-trivia">0%</b></div>
                    </div>

                    <div style="margin-top:20px;">
                        <label>Actualizar WhatsApp</label>
                        <input type="text" id="profWA" placeholder="+57 300...">
                        <button class="btn-gold" style="padding:10px; margin-top:10px; font-size:12px;" onclick="guardarPerfil()">GUARDAR DATOS</button>
                    </div>
                </div>

                <h3 style="color:var(--gold); margin-top:30px;"><i class="fas fa-list-ul"></i> MIS PRÓXIMAS CLASES</h3>
                <div id="listaReservas">
                    </div>
            </div>
        </div>
    </div>

</div>

<script>
/* ---------- CONFIGURACIÓN SUPABASE ---------- */
const SUPABASE_URL = "https://aldwcqpgsjfjcttxfecp.supabase.co"; 
const SUPABASE_KEY = "sb_publishable_OvQYw50Cs8sM21AJGg21zg_v3LunT3J"; // REEMPLAZAR CON TU LLAVE ANON

const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    db: { schema: 'academia_elite' }
});

/* ---------- LÓGICA DE NAVEGACIÓN ---------- */
function toggleMenu() { document.getElementById("menu").classList.toggle("show"); }

function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id === 'dashboard') {
        document.getElementById('btnLogOut').style.display = 'block';
        cargarDatosAlumno();
        cargarReservas();
    }
}

/* ---------- AUTENTICACIÓN ---------- */
async function login() {
    const email = document.getElementById("loginEmail").value;
    const pass = document.getElementById("loginPass").value;
    const { data, error } = await _supabase.auth.signInWithPassword({ email, password: pass });
    if(error) alert("Error: " + error.message);
    else showSection('dashboard');
}

async function registrar() {
    const pinsValidos = ["A123", "B123"];
    const nombre = document.getElementById("regNombre").value;
    const email = document.getElementById("regEmail").value;
    const pass = document.getElementById("regPass").value;
    const pin = document.getElementById("regPin").value;

    if(!pinsValidos.includes(pin)) return alert("PIN no válido");

    const { data, error } = await _supabase.auth.signUp({ 
        email, password: pass, options: { data: { nombre_completo: nombre } } 
    });

    if(error) alert(error.message);
    else {
        await _supabase.from('alumnos').insert({ id: data.user.id, nombre_completo: nombre, email: email });
        alert("Registro exitoso");
        showSection('login');
    }
}

async function logout() {
    await _supabase.auth.signOut();
    location.reload();
}

/* ---------- DATOS DEL ALUMNO ---------- */
async function cargarDatosAlumno() {
    const { data: { user } } = await _supabase.auth.getUser();
    if(!user) return;

    const { data: alumno } = await _supabase.from('alumnos').select('*').eq('id', user.id).single();
    if(alumno) {
        document.getElementById('dispNombre').innerText = alumno.nombre_completo.toUpperCase();
        document.getElementById('stat-trivia').innerText = (alumno.puntaje_trivia || 0) + "%";
        document.getElementById('stat-clases').innerText = (alumno.clases_realizadas || 0) + "/20";
        document.getElementById('profWA').value = alumno.whatsapp || "";
        if(alumno.avatar_url) document.getElementById('currentAvatar').src = alumno.avatar_url;
    }
}

async function guardarPerfil() {
    const { data: { user } } = await _supabase.auth.getUser();
    const wa = document.getElementById('profWA').value;
    const { error } = await _supabase.from('alumnos').update({ whatsapp: wa }).eq('id', user.id);
    if(!error) alert("Datos actualizados");
}

/* ---------- AGENDAMIENTO CON CUPOS ---------- */
const fechaInput = document.getElementById("fecha");
const horaSelect = document.getElementById("hora");
const instructorSelect = document.getElementById("instructor");

fechaInput.min = new Date().toISOString().split("T")[0];
fechaInput.addEventListener('change', verificarCupos);
instructorSelect.addEventListener('change', verificarCupos);

async function verificarCupos() {
    const fecha = fechaInput.value;
    const inst = instructorSelect.value;
    if(!fecha) return;

    // Reset select
    Array.from(horaSelect.options).forEach(opt => {