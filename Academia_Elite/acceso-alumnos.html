<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso Seguro | Academia de Conducci√≥n √âlite</title>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Estilos Tem√°ticos -->
    <link rel="stylesheet" href="css/theme-elite-asphalt.css">

    <style>
        /* ESTILOS CR√çTICOS INLINE (Para asegurar visualizaci√≥n) */
        :root {
            --gold: #c5a059;
            --dark: #111;
            --error: #ff4444;
            --success: #00C851;
        }

        body {
            background-color: #050505;
            background-image: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            color: white;
            font-family: sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }

        .auth-card {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid rgba(197, 160, 89, 0.3);
            border-radius: 15px;
            padding: 2rem;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            position: relative;
        }

        /* NAVEGACI√ìN Y TABS */
        .btn-back {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ccc;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-bottom: 20px;
            display: inline-block;
            transition: 0.3s;
        }

        .btn-back:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #333;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 12px;
            color: #666;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .tab-btn.active {
            color: var(--gold);
            border-bottom: 2px solid var(--gold);
            margin-bottom: -2px;
        }

        /* FORMULARIOS */
        .form-container {
            display: none;
            /* Oculto por defecto */
        }

        .form-container.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            color: var(--gold);
            font-size: 0.8rem;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-wrapper {
            position: relative;
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            background: #000;
            border: 1px solid #333;
            color: white;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        input:focus {
            border-color: var(--gold);
            outline: none;
        }

        /* LOGIN BUTTONS */
        .btn-submit {
            width: 100%;
            padding: 14px;
            background: var(--gold);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
            text-transform: uppercase;
            transition: 0.2s;
        }

        .btn-submit:hover {
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(197, 160, 89, 0.4);
        }

        .btn-whatsapp {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, #25D366, #128C7E);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* UTILS */
        .eye-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 1.2rem;
            color: #666;
            z-index: 10;
        }

        .eye-icon:hover {
            color: var(--gold);
        }

        .req-box {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 0.8rem;
            display: none;
        }

        .req-box.show {
            display: block;
        }

        .req-item {
            color: #666;
            margin-bottom: 2px;
        }

        .req-item.valid {
            color: var(--success);
        }

        .req-item::before {
            content: "‚Ä¢ ";
        }

        .req-item.valid::before {
            content: "‚úì ";
        }

        .link-text {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: #888;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .link-text:hover {
            color: var(--gold);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="auth-card">
        <!-- HEADER -->
        <button class="btn-back" id="btnHome">‚Üê Volver al Inicio</button>

        <div class="tabs">
            <button class="tab-btn active" data-target="login">Ingreso</button>
            <button class="tab-btn" data-target="registro">Registro</button>
        </div>

        <!-- SECCI√ìN LOGIN -->
        <div id="login" class="form-container active">
            <h2 style="text-align:center; color:white; margin-top:0;">Bienvenido</h2>

            <form id="formLogin">
                <div class="form-group">
                    <label>Usuario (Email)</label>
                    <input type="email" id="loginEmail" maxlength="80" placeholder="correo@ejemplo.com" required>
                </div>

                <div class="form-group">
                    <label>Contrase√±a</label>
                    <div class="input-wrapper">
                        <input type="password" id="loginPass" maxlength="80" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        <span class="eye-icon" title="Ver contrase√±a">üëÅÔ∏è</span>
                    </div>
                </div>

                <button type="submit" class="btn-submit">Ingresar</button>
            </form>

            <a href="#" class="link-text" id="linkRecover">¬øOlvidaste tu contrase√±a? Recup√©rala aqu√≠</a>
        </div>

        <!-- SECCI√ìN REGISTRO -->
        <div id="registro" class="form-container">
            <h2 style="text-align:center; color:white; margin-top:0;">Matr√≠cula Nueva</h2>

            <form id="formRegister">
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" id="regName" maxlength="100" placeholder="Ej: Juan P√©rez" required>
                </div>

                <div class="form-group">
                    <label>Correo Electr√≥nico</label>
                    <input type="email" id="regEmail" maxlength="80" placeholder="correo@ejemplo.com" required>
                </div>

                <div class="form-group">
                    <label>Categor√≠a</label>
                    <select id="regCategory" required>
                        <option value="" disabled selected>Selecciona Licencia...</option>
                        <option value="A2">A2 - Moto</option>
                        <option value="B1">B1 - Autom√≥vil</option>
                        <option value="B2">B2 - Cami√≥n/Buseta</option>
                        <option value="C1">C1 - Servicio P√∫blico</option>
                        <option value="C2">C2 - Cami√≥n R√≠gido</option>
                        <option value="C3">C3 - Articulado</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Contrase√±a</label>
                    <div class="input-wrapper">
                        <input type="password" id="regPass" maxlength="80" placeholder="Crear contrase√±a" required>
                        <span class="eye-icon" title="Ver contrase√±a">üëÅÔ∏è</span>
                    </div>
                    <!-- Requisitos Password -->
                    <div class="req-box" id="passMeters">
                        <div class="req-item" id="chk-len">M√≠nimo 8 caracteres</div>
                        <div class="req-item" id="chk-upp">Al menos 1 May√∫scula</div>
                        <div class="req-item" id="chk-num">Al menos 1 N√∫mero</div>
                        <div class="req-item" id="chk-spe">Al menos 1 S√≠mbolo (!@#$)</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Verificar Contrase√±a</label>
                    <div class="input-wrapper">
                        <input type="password" id="regPass2" maxlength="80" placeholder="Repetir contrase√±a" required>
                        <span class="eye-icon" title="Ver contrase√±a">üëÅÔ∏è</span>
                    </div>
                </div>

                <hr style="border-color: #333; margin: 20px 0;">

                <div class="form-group">
                    <label>PIN de Activaci√≥n</label>
                    <p style="font-size: 0.8rem; color:#888; margin-top:0;">Ingresa tu c√≥digo de alumno (A123, B123,
                        C123)</p>
                    <input type="text" id="regPin" placeholder="Ej: A123"
                        style="text-align:center; letter-spacing:3px; text-transform:uppercase; font-weight:bold; color:var(--gold);">
                </div>

                <button type="submit" class="btn-submit">Registrarme & Acceder</button>

                <button type="button" class="btn-whatsapp" id="btnAskPin">
                    <span>üì± SOLICITAR PIN POR WHATSAPP</span>
                </button>
            </form>
        </div>
    </div>

    <!-- SCRIPT "CLEAN SLATE" (Todo en uno para evitar errores de carga) -->
    <script>
        // CONFIGURACI√ìN
        const CONFIG = {
            whatsappNumber: "573133482932",
            validPins: ["A123", "B123", "C123"],
            supabaseUrl: 'https://aldwcqpgsjfjcttxfecp.supabase.co',
            supabaseKey: 'sb_publishable_OvQYw50Cs8sM21AJGg21zg_v3LunT3J'
        };

        // ESTADO GLOBAL
        let supabaseClient = null;

        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("üü¢ ACCESO ALUMNOS: Iniciando sistema...");

            initSupabase();
            setupTabs();
            setupEyes();
            setupForms();
            setupPasswordLogic();

            // Bot√≥n Home
            document.getElementById('btnHome').addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            // Bot√≥n PIN WhatsApp
            document.getElementById('btnAskPin').addEventListener('click', requestPinAction);

            // Link Recuperar
            document.getElementById('linkRecover').addEventListener('click', (e) => {
                e.preventDefault();
                window.open(`https://wa.me/${CONFIG.whatsappNumber}?text=Hola, olvid√© mi contrase√±a. Ayuda.`, '_blank');
            });
        });

        // --- 1. SUPABASE ---
        function initSupabase() {
            try {
                if (typeof supabase !== 'undefined') {
                    supabaseClient = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
                    console.log("‚úÖ DB Conectada");
                } else {
                    alert("‚ö†Ô∏è Error: No se pudo cargar el m√≥dulo de base de datos.");
                }
            } catch (err) {
                console.error("Supabase Error:", err);
            }
        }

        // --- 2. TABS INTERACTIVO ---
        function setupTabs() {
            const btns = document.querySelectorAll('.tab-btn');
            const forms = document.querySelectorAll('.form-container');

            btns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remover activos
                    btns.forEach(b => b.classList.remove('active'));
                    forms.forEach(f => f.classList.remove('active'));

                    // Activar actual
                    btn.classList.add('active');
                    const targetId = btn.getAttribute('data-target');
                    document.getElementById(targetId).classList.add('active');
                });
            });
        }

        // --- 3. ICONOS OJO (L√≥gica Robusta v3) ---
        function setupEyes() {
            document.querySelectorAll('.eye-icon').forEach(icon => {
                icon.addEventListener('click', function () {
                    // Usamos .previousElementSibling que es m√°s directo en esta estructura HTML fija
                    // O el m√©todo wrapper para seguridad extrema
                    const wrapper = this.parentElement;
                    const input = wrapper.querySelector('input');

                    if (input) {
                        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                        input.setAttribute('type', type);
                        this.style.opacity = type === 'text' ? '1' : '0.5';
                    }
                });
            });
        }

        // --- 4. VALIDACI√ìN PASSWORD REAL-TIME ---
        function setupPasswordLogic() {
            const input = document.getElementById('regPass');
            const box = document.getElementById('passMeters');

            if (!input) return;

            input.addEventListener('focus', () => box.classList.add('show'));

            input.addEventListener('input', () => {
                const val = input.value;
                checkRule('chk-len', val.length >= 8);
                checkRule('chk-upp', /[A-Z]/.test(val));
                checkRule('chk-num', /[0-9]/.test(val));
                checkRule('chk-spe', /[!@#$%^&*]/.test(val));
            });
        }

        function checkRule(id, isValid) {
            const el = document.getElementById(id);
            if (isValid) el.classList.add('valid');
            else el.classList.remove('valid');
        }

        // --- 5. L√ìGICA DE FORMULARIOS ---
        function setupForms() {
            // LOGIN
            document.getElementById('formLogin').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!supabaseClient) return alert("Error de conexi√≥n");

                const email = document.getElementById('loginEmail').value;
                const pass = document.getElementById('loginPass').value;
                const btn = e.target.querySelector('button');

                btn.textContent = "Verificando...";
                btn.disabled = true;

                try {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: email, password: pass
                    });

                    if (error) throw error;

                    // Verificar/Crear Perfil en DB
                    await ensureProfile(data.user, email);

                    window.location.href = "dashboard-alumno.html";

                } catch (err) {
                    alert("‚ùå Error: " + (err.message || "Credenciales incorrectas"));
                    btn.textContent = "Ingresar";
                    btn.disabled = false;
                }
            });

            // REGISTRO
            document.getElementById('formRegister').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!supabaseClient) return alert("Error de conexi√≥n");

                const name = document.getElementById('regName').value.trim();
                const email = document.getElementById('regEmail').value.trim();
                const cat = document.getElementById('regCategory').value;
                const pass = document.getElementById('regPass').value;
                const pass2 = document.getElementById('regPass2').value;
                const pin = document.getElementById('regPin').value.trim().toUpperCase();

                // Validaciones
                if (pass !== pass2) return alert("‚ùå Las contrase√±as no coinciden");
                if (!CONFIG.validPins.includes(pin)) return alert("‚ùå PIN Inv√°lido. Solicita uno nuevo.");

                // Password fuerte regex
                if (!/^(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*]).{8,}$/.test(pass)) {
                    return alert("‚ö†Ô∏è La contrase√±a no cumple los requisitos de seguridad.");
                }

                const btn = e.target.querySelector('button[type="submit"]');
                btn.textContent = "Registrando...";
                btn.disabled = true;

                try {
                    const { data, error } = await supabaseClient.auth.signUp({
                        email: email, password: pass,
                        options: { data: { full_name: name, category: cat } }
                    });

                    if (error) throw error;

                    if (data.user) {
                        // Insertar en tabla p√∫blica
                        await supabaseClient.from('alumnos').insert([{
                            id: data.user.id,
                            email: email,
                            nombre: name,
                            categoria: cat,
                            activo: true
                        }]);

                        alert("‚úÖ Cuenta creada con √©xito!");
                        // Recargar para ir al login (o auto-login manual)
                        window.location.reload();
                    }
                } catch (err) {
                    alert("‚ùå Error Registro: " + err.message);
                    btn.textContent = "Registrarme & Acceder";
                    btn.disabled = false;
                }
            });
        }

        // --- AUXILIARES ---
        async function ensureProfile(user, email) {
            const { data } = await supabaseClient.from('alumnos').select('id').eq('id', user.id).single();
            if (!data) {
                await supabaseClient.from('alumnos').insert([{
                    id: user.id, email: email,
                    nombre: user.user_metadata.full_name || "Alumno",
                    categoria: 'B1', activo: true
                }]);
            }
        }

        function requestPinAction() {
            const name = document.getElementById('regName').value || "[Mi Nombre]";
            const cat = document.getElementById('regCategory').value || "[Categor√≠a]";

            const text = `Hola üëã, soy ${name}. Estoy matriculado para la licencia ${cat}. Necesito acceso a la plataforma para agendar mis clases pr√°cticas üöó.`;

            const url = `https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

    </script>
</body>

</html>