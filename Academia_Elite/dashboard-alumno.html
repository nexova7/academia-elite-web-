<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel √âlite Drive</title>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/biblioteca-vial-elite.css">
</head>

<body>

    <body>

        <!-- STICKY HEADER DASHBOARD -->
        <nav class="dashboard-navbar">
            <div class="logo-text">√âLITE <span style="color:var(--elite-gold)">DRIVE</span></div>
            <div class="dashboard-toggle" onclick="toggleDashboardMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </nav>

        <!-- MEN√ö COMPACTO DESPLEGABLE -->
        <div class="dashboard-compact-menu" id="compactMenu">
            <button class="nav-btn active" onclick="nav('perfil')">üë§ Mi Perfil</button>
            <button class="nav-btn" onclick="nav('lecciones')">üìö Mis Lecciones</button>
            <button class="nav-btn" onclick="nav('clases')">üóìÔ∏è Calendario Pr√°ctico</button>
            <hr style="border:0; border-top:1px solid var(--elite-border); margin:10px 0;">
            <a href="index.html" class="logout">CERRAR SESI√ìN</a>
        </div>

        <!-- OVERLAY -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleDashboardMenu()"></div>

        <div class="content">
            <!-- PANEL DE BIENVENIDA (RESUMEN √âLITE) -->
            <div id="resumen-elite" class="section active">
                <div class="banner-welcome">
                    <h1 id="welcomeGreeting">¬°Bienvenido, <span id="studentNameDisplay">Aspirante √âlite</span>!</h1>
                    <p>Tu camino hacia la maestr√≠a al volante contin√∫a hoy.</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card-glass">
                        <i class="fa-solid fa-car-side"></i>
                        <h3 id="clasesCompletadas">0</h3>
                        <p>Clases Completadas</p>
                    </div>

                    <div class="stat-card-glass">
                        <i class="fa-solid fa-calendar-check"></i>
                        <h3 id="proximaClase">--/--</h3>
                        <p>Pr√≥xima Clase</p>
                    </div>
                    <div class="stat-card-glass progress-stat">
                        <div class="progress-circle-container">
                            <svg viewBox="0 0 36 36" class="circular-chart gold">
                                <path class="circle-bg"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                <path id="progressCircle" class="circle" stroke-dasharray="0, 100"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                <text x="18" y="20.35" class="percentage" id="progressText">0%</text>
                            </svg>
                        </div>
                        <p>Progreso Licencia <span id="licenciaCategoria">--</span></p>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN PERFIL (ESTILO LICENCIA) -->
            <div id="perfil" class="section">
                <h1>Identidad & Seguridad</h1>
                <p class="section-desc">Gestiona tu licencia digital y credenciales de acceso.</p>

                <div class="license-card-container">
                    <div class="license-card">
                        <div class="micro-texture"></div>

                        <div class="avatar-side">
                            <div class="avatar-container">
                                <img src="mascota masculina.png" id="pfp" class="avatar-main">
                                <div class="upload-overlay" onclick="document.getElementById('pfpInput').click()">
                                    <span>SUBIR FOTO</span>
                                </div>
                                <button class="btn-upload" title="Subir Foto"
                                    onclick="document.getElementById('pfpInput').click()">+</button>
                                <input type="file" id="pfpInput" hidden accept="image/*"
                                    onchange="handleImageUpload(event)">
                            </div>
                            <p class="avatar-grid-trigger" onclick="toggleAvatars()">AVATARES √âLITE</p>

                            <div id="avatarGrid" class="avatar-grid">
                                <img src="pixel_avatar_men_1.jpeg" class="avatar-opt" onclick="changePfp(this.src)">
                                <img src="pixel_avatar_men_2.jpeg" class="avatar-opt" onclick="changePfp(this.src)">
                                <img src="pixel_avatar_men_3.jpeg" class="avatar-opt" onclick="changePfp(this.src)">
                                <img src="pixel_avatar_men_4.jpeg" class="avatar-opt" onclick="changePfp(this.src)">
                                <img src="pixel_avatar_women_1.jpeg" class="avatar-opt" onclick="changePfp(this.src)">
                                <img src="pixel_avatar_women_2.jpeg" class="avatar-opt" onclick="changePfp(this.src)">
                                <img src="pixel_avatar_women_3.jpeg" class="avatar-opt" onclick="changePfp(this.src)">
                                <img src="pixel_avatar_women_4.jpeg" class="avatar-opt" onclick="changePfp(this.src)">
                            </div>
                        </div>

                        <div class="info-side">
                            <div class="field-grid">
                                <div class="license-field">
                                    <label>Nombre Completo</label>
                                    <input type="text" id="userName" class="input-glass">
                                </div>
                                <div class="license-field">
                                    <label>Categor√≠a</label>
                                    <input type="text" id="userCategory" class="input-glass" disabled>
                                </div>
                                <div class="license-field">
                                    <label>WhatsApp</label>
                                    <input type="text" id="userPhone" class="input-glass">
                                </div>
                                <div class="license-field">
                                    <label>Email Institucional</label>
                                    <input type="email" id="userEmail" class="input-glass">
                                </div>
                            </div>

                            <hr class="license-divider">

                            <h4 class="security-title"><i class="fa-solid fa-shield-halved"></i> Seguridad de Acceso
                            </h4>
                            <div class="field-grid">
                                <div>
                                    <label class="field-label-sm">Nueva Contrase√±a</label>
                                    <input type="password" id="newPassword" class="input-glass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                                <div>
                                    <label class="field-label-sm">Confirmar Contrase√±a</label>
                                    <input type="password" id="confirmPassword" class="input-glass"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                            </div>
                            <p id="passError" class="error-msg">* Las contrase√±as no coinciden</p>

                            <button onclick="saveProfile()" class="btn-save">GUARDAR CAMBIOS</button>
                        </div>

                        <div class="license-seal">
                            <i class="fa-solid fa-shield-cat"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN LECCIONES -->
            <div id="lecciones" class="section">
                <div id="biblioteca-vial-elite">
                    <h2 class="section-title" style="text-align: left; font-size: 1.8rem; margin-bottom: 20px;">
                        Masterclass √âlite: Domina la V√≠a con Expertos</h2>

                    <div class="netflix-row" id="dashboard-video-grid">
                        <!-- Los videos se cargar√°n por JS al final del archivo -->
                    </div>
                </div>
            </div>

            <!-- MODAL PARA DASHBOARD -->
            <div class="elite-modal" id="dashboardModal">
                <div class="modal-content">
                    <button class="modal-close" id="closeDashboardModal">&times;</button>
                    <div class="modal-video-wrapper" id="dashboardModalVideoContainer"></div>
                    <div class="modal-body">
                        <span class="modal-tag">Lecci√≥n √âlite</span>
                        <h3 class="modal-title" id="dashboardModalTitle">T√≠tulo</h3>
                        <p class="modal-description" id="dashboardModalDesc">Descripci√≥n</p>
                    </div>
                </div>
            </div>



            <div id="clases" class="section">
                <h1 class="mb-xs">üìÖ Mis Clases Pr√°cticas</h1>
                <p class="section-desc mb-md">Agenda tus clases con nuestros instructores √©lite. Recuerda: m√≠nimo 8
                    horas de
                    anticipaci√≥n para cancelaciones.</p>

                <div class="calendar-container">
                    <!-- FORMULARIO DE RESERVA -->
                    <div class="calendar-form-card">
                        <div class="card-header">
                            <i class="fa-solid fa-calendar-plus"></i>
                            <h3>Nueva Reserva</h3>
                        </div>

                        <div class="form-grid">
                            <!-- Instructor -->
                            <div class="form-field">
                                <label>
                                    <i class="fa-solid fa-user-tie"></i>
                                    Instructor √âlite
                                </label>
                                <select id="reservaInstructor" class="input-glass">
                                    <option value="">Selecciona un instructor</option>
                                    <option value="Instructora Liliana">üë©‚Äçüè´ Instructora Liliana</option>
                                    <option value="Instructor Camilo">üë®‚Äçüè´ Instructor Camilo</option>
                                </select>
                            </div>

                            <!-- Fecha -->
                            <div class="form-field">
                                <label>
                                    <i class="fa-solid fa-calendar-day"></i>
                                    Fecha de Pr√°ctica
                                </label>
                                <input type="date" id="reservaFecha" class="input-glass">
                                <small class="field-hint" id="fechaHint"></small>
                            </div>

                            <!-- Hora -->
                            <div class="form-field">
                                <label>
                                    <i class="fa-solid fa-clock"></i>
                                    Franja Horaria (2 horas)
                                </label>
                                <select id="reservaHora" class="input-glass">
                                    <option value="">Selecciona horario</option>
                                    <option value="06:00">üåÖ 06:00 AM - 08:00 AM</option>
                                    <option value="08:30">‚òÄÔ∏è 08:30 AM - 10:30 AM</option>
                                    <option value="11:00">üå§Ô∏è 11:00 AM - 01:00 PM</option>
                                    <option value="13:30">üåû 01:30 PM - 03:30 PM</option>
                                    <option value="16:00">üåÜ 04:00 PM - 06:00 PM</option>
                                </select>
                                <small class="field-hint" id="horaHint"></small>
                            </div>

                            <!-- Notas (Opcional) -->
                            <div class="form-field full-width">
                                <label>
                                    <i class="fa-solid fa-note-sticky"></i>
                                    Notas Adicionales (Opcional)
                                </label>
                                <textarea id="reservaNotas" class="input-glass" rows="3"
                                    placeholder="Ej: Necesito practicar estacionamiento en paralelo..."></textarea>
                            </div>

                            <!-- Bot√≥n de Confirmar -->
                            <div class="form-field full-width">
                                <button class="btn-confirm-reservation" onclick="agendarClase()">
                                    <i class="fa-solid fa-check-circle"></i>
                                    CONFIRMAR RESERVA
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- LISTA DE CLASES AGENDADAS -->
                    <div class="calendar-list-card">
                        <div class="card-header">
                            <i class="fa-solid fa-list-check"></i>
                            <h3>Mis Clases Agendadas</h3>
                        </div>

                        <div id="listaClases" class="reservations-list">
                            <!-- Las clases se cargan din√°micamente aqu√≠ -->
                            <div class="empty-state">
                                <i class="fa-solid fa-calendar-xmark"></i>
                                <p>No tienes clases agendadas</p>
                                <small>Reserva tu primera clase usando el formulario</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN DE NOTAS DEL INSTRUCTOR -->
                <div class="instructor-notes-section">
                    <div class="card-header">
                        <i class="fa-solid fa-comment-dots"></i>
                        <h3>Notas del Instructor</h3>
                    </div>
                    <div id="notasInstructor" class="notes-container">
                        <div class="empty-state">
                            <i class="fa-solid fa-inbox"></i>
                            <p>No hay notas del instructor</p>
                            <small>Las notas aparecer√°n despu√©s de tus clases</small>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                // --- CONFIGURACI√ìN DE CONEXI√ìN ---
                // --- CONFIGURACI√ìN DE CONEXI√ìN ---
                // Usamos la instancia segura cargada desde js/supabase-config.js
                window.supabaseClient = window.supabaseInstance;
                window.currentUserId = null;
                window.isDemoUser = false;

                // --- GESTOR DE DATOS (HYBRID: SUPABASE + LOCALSTORAGE) ---
                const DataManager = {
                    // Claves para LocalStorage
                    KEYS: {
                        PROFILE: 'elite_demo_profile',
                        CLASSES: 'elite_demo_classes',
                        NOTES: 'elite_demo_notes'
                    },

                    // Inicializar datos demo si no existen
                    initDemoData: () => {
                        if (!localStorage.getItem(DataManager.KEYS.PROFILE)) {
                            const defaultProfile = {
                                nombre: "Aspirante √âlite (Demo)",
                                whatsapp: "+57 300 123 4567",
                                email: "aspirante@elite.com",
                                categoria: "B1 Particular",
                                avatar_url: "https://cdn-icons-png.flaticon.com/512/4140/4140048.png",
                                clases_completadas: 5,
                                progreso: 45
                            };
                            localStorage.setItem(DataManager.KEYS.PROFILE, JSON.stringify(defaultProfile));
                        }
                        if (!localStorage.getItem(DataManager.KEYS.CLASSES)) {
                            localStorage.setItem(DataManager.KEYS.CLASSES, JSON.stringify([]));
                        }
                    },

                    // --- PERFIL ---
                    async getProfile() {
                        if (window.isDemoUser) {
                            return JSON.parse(localStorage.getItem(DataManager.KEYS.PROFILE));
                        } else {
                            const { data, error } = await window.supabaseClient
                                .from('alumnos')
                                .select('*')
                                .eq('id', window.currentUserId)
                                .single();
                            if (error) throw error;
                            return data;
                        }
                    },

                    async updateProfile(updates) {
                        if (window.isDemoUser) {
                            const current = JSON.parse(localStorage.getItem(DataManager.KEYS.PROFILE));
                            const updated = { ...current, ...updates };
                            localStorage.setItem(DataManager.KEYS.PROFILE, JSON.stringify(updated));
                            return { data: updated, error: null };
                        } else {
                            return await window.supabaseClient
                                .from('alumnos')
                                .update(updates)
                                .eq('id', window.currentUserId);
                        }
                    },

                    async updatePassword(newPass) {
                        if (window.isDemoUser) {
                            // En modo demo no cambiamos la contrase√±a real, pero simulamos √©xito
                            return { error: null };
                        } else {
                            return await window.supabaseClient.auth.updateUser({ password: newPass });
                        }
                    },

                    // --- CLASES ---
                    async getClasses() {
                        if (window.isDemoUser) {
                            const classes = JSON.parse(localStorage.getItem(DataManager.KEYS.CLASSES)) || [];
                            return classes.filter(c => c.estado !== 'CANCELADA').sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                        } else {
                            const { data, error } = await window.supabaseClient
                                .from('reservas_clases')
                                .select('*')
                                .eq('alumno_id', window.currentUserId)
                                .neq('estado', 'CANCELADA')
                                .order('fecha', { ascending: true });
                            if (error) throw error;
                            return data;
                        }
                    },

                    async checkConflicts(instructor, fecha, hora) {
                        if (window.isDemoUser) {
                            const classes = JSON.parse(localStorage.getItem(DataManager.KEYS.CLASSES)) || [];
                            // Conflicto Instructor (Simulado: si ya hay una clase con ese instructor a esa hora en MIS reservas - simplificaci√≥n)
                            // En un sistema real, un usuario local no sabe las reservas de OTROS. 
                            // Para la demo, asumimos que el instructor est√° libre a menos que YO tenga clase.
                            // O podemos simular aleatoriamente ocupado:
                            // if (Math.random() > 0.9) return { error: "Horario no disponible con este instructor." };

                            const myConflict = classes.some(c => c.fecha === fecha && c.hora === hora && c.estado !== 'CANCELADA');
                            if (myConflict) return { error: "Ya tienes clase a esa hora." };

                            return { error: null };
                        } else {
                            // L√≥gica Supabase original
                            const { data: conflictos } = await window.supabaseClient
                                .from('reservas_clases')
                                .select('*')
                                .eq('instructor', instructor)
                                .eq('fecha', fecha)
                                .eq('hora', hora)
                                .neq('estado', 'CANCELADA');
                            if (conflictos && conflictos.length > 0) return { error: "Horario no disponible con este instructor." };

                            const { data: miConflicto } = await window.supabaseClient
                                .from('reservas_clases')
                                .select('*')
                                .eq('alumno_id', window.currentUserId)
                                .eq('fecha', fecha)
                                .eq('hora', hora)
                                .neq('estado', 'CANCELADA');
                            if (miConflicto && miConflicto.length > 0) return { error: "Ya tienes clase a esa hora." };

                            return { error: null };
                        }
                    },

                    async addClass(reservation) {
                        if (window.isDemoUser) {
                            const classes = JSON.parse(localStorage.getItem(DataManager.KEYS.CLASSES)) || [];
                            // Generar ID falso
                            reservation.id = 'demo-' + Date.now();
                            reservation.alumno_id = 'demo-user';
                            classes.push(reservation);
                            localStorage.setItem(DataManager.KEYS.CLASSES, JSON.stringify(classes));
                            return { error: null };
                        } else {
                            return await window.supabaseClient
                                .from('reservas_clases')
                                .insert([reservation]);
                        }
                    },

                    async cancelClass(id) {
                        if (window.isDemoUser) {
                            let classes = JSON.parse(localStorage.getItem(DataManager.KEYS.CLASSES)) || [];
                            // En local storage las eliminamos o marcamos canceladas. Marcamos para consistencia.
                            classes = classes.map(c => {
                                if (c.id === id) c.estado = 'CANCELADA';
                                return c;
                            });
                            localStorage.setItem(DataManager.KEYS.CLASSES, JSON.stringify(classes));
                            return { error: null };
                        } else {
                            return await window.supabaseClient
                                .from('reservas_clases')
                                .update({ estado: 'CANCELADA' })
                                .eq('id', id);
                        }
                    },

                    // --- NOTAS ---
                    async getNotes() {
                        // Por ahora mock para ambos
                        const mockNotas = [];
                        // Ejemplo: { fecha: '2023-10-27', texto: 'Buen trabajo.' }
                        return mockNotas;
                    }
                };

                // --- L√ìGICA PRINCIPAL ---

                document.addEventListener('DOMContentLoaded', async () => {
                    const hoy = new Date().toISOString().split('T')[0];
                    const inputFecha = document.getElementById('reservaFecha');
                    if (inputFecha) {
                        inputFecha.setAttribute('min', hoy);
                        inputFecha.addEventListener('change', function () {
                            const dia = new Date(this.value).getUTCDay();
                            if (dia === 0) {
                                alert("SISTEMA √âLITE: No se agendan clases los domingos.");
                                this.value = "";
                            }
                        });
                    }

                    const { data: { session } } = await window.supabaseClient.auth.getSession();

                    if (session) {
                        window.currentUserId = session.user.id;
                        window.isDemoUser = false;
                    } else {
                        console.warn("Sesi√≥n no detectada. Iniciando MODO DEMO.");
                        window.currentUserId = "00000000-0000-0000-0000-000000000000";
                        window.isDemoUser = true;
                        DataManager.initDemoData();
                    }

                    await loadStudentData();
                    await renderizarClases();
                    await loadInstructorNotes();
                });

                async function loadStudentData() {
                    try {
                        const data = await DataManager.getProfile();

                        if (data) {
                            document.getElementById('studentNameDisplay').innerText = data.nombre || "Alumno";
                            document.getElementById('userName').value = data.nombre || "";
                            document.getElementById('userPhone').value = data.whatsapp || "";
                            document.getElementById('userEmail').value = data.email || "";
                            document.getElementById('userCategory').value = data.categoria || "N/A";
                            document.getElementById('licenciaCategoria').innerText = data.categoria || "B1";
                            if (data.avatar_url) document.getElementById('pfp').src = data.avatar_url;
                            document.getElementById('clasesCompletadas').innerText = data.clases_completadas || 0;

                            // Recalcular pr√≥xima clase
                            const allClasses = await DataManager.getClasses();
                            const now = new Date();
                            const upcoming = allClasses
                                .filter(c => new Date(c.fecha + 'T' + c.hora) >= now)
                                .sort((a, b) => new Date(a.fecha + 'T' + a.hora) - new Date(b.fecha + 'T' + b.hora));

                            if (upcoming.length > 0) {
                                document.getElementById('proximaClase').innerText = upcoming[0].fecha;
                            } else {
                                document.getElementById('proximaClase').innerText = "--/--";
                            }

                            updateCircularProgress(data.progreso || 0);
                        }
                    } catch (err) {
                        console.error("Error cargando perfil:", err);
                    }
                }

                function updateCircularProgress(percent) {
                    const circle = document.getElementById('progressCircle');
                    const text = document.getElementById('progressText');
                    if (circle) {
                        const offset = percent + ", 100";
                        circle.style.strokeDasharray = offset;
                        text.innerText = percent + "%";
                    }
                }

                function nav(id) {
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    const targetSection = document.getElementById(id);
                    if (targetSection) targetSection.classList.add('active');
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        const onclickAttr = btn.getAttribute('onclick');
                        if (onclickAttr && onclickAttr.includes(`'${id}'`)) btn.classList.add('active');
                    });

                    // Cerrar el men√∫ si est√° abierto
                    const menu = document.getElementById('compactMenu');
                    if (menu && menu.classList.contains('active')) toggleDashboardMenu();
                }

                // --- AVATAR & PERFIL ---
                function handleImageUpload(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) { document.getElementById('pfp').src = e.target.result; };
                        reader.readAsDataURL(file);
                    }
                }

                function toggleAvatars() {
                    document.getElementById('avatarGrid').classList.toggle('show');
                }

                function changePfp(src) {
                    document.getElementById('pfp').src = src;
                    document.getElementById('avatarGrid').classList.remove('show');
                }

                async function saveProfile() {
                    const btn = event.currentTarget;
                    const originalText = btn.innerText;
                    const userName = document.getElementById('userName').value;
                    const userPhone = document.getElementById('userPhone').value;
                    const userEmail = document.getElementById('userEmail').value;
                    const userAvatar = document.getElementById('pfp').src;
                    const newPass = document.getElementById('newPassword').value;
                    const confirmPass = document.getElementById('confirmPassword').value;

                    const passError = document.getElementById('passError');
                    if (newPass || confirmPass) {
                        if (newPass !== confirmPass) { passError.style.display = 'block'; return; }
                        if (newPass.length < 6) { alert("La contrase√±a debe tener al menos 6 caracteres."); return; }
                    }
                    passError.style.display = 'none';

                    btn.innerText = "PROCESANDO...";
                    btn.disabled = true;

                    try {
                        const updates = { nombre: userName, whatsapp: userPhone, email: userEmail, avatar_url: userAvatar };
                        const { error } = await DataManager.updateProfile(updates);
                        if (error) throw error;

                        if (newPass) {
                            const { error: authError } = await DataManager.updatePassword(newPass);
                            if (authError) throw authError;
                        }
                        alert("¬°√âXITO! Tu perfil √âlite ha sido actualizado.");
                        location.reload();
                    } catch (err) {
                        console.error("Error al guardar:", err);
                        alert("Error al guardar: " + (err.message || "Error desconocido"));
                    } finally {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                }

                // --- AGENDAMIENTO ---
                async function agendarClase() {
                    const inst = document.getElementById('reservaInstructor').value;
                    const fecha = document.getElementById('reservaFecha').value;
                    const hora = document.getElementById('reservaHora').value;
                    const notas = document.getElementById('reservaNotas').value || null;

                    if (!inst) return alert("‚ö†Ô∏è Selecciona un instructor");
                    if (!fecha) return alert("‚ö†Ô∏è Selecciona una fecha");
                    if (!hora) return alert("‚ö†Ô∏è Selecciona un horario");

                    const fechaSeleccionada = new Date(fecha + 'T00:00:00');
                    const hoy = new Date();
                    hoy.setHours(0, 0, 0, 0);

                    if (fechaSeleccionada < hoy) return alert("‚ö†Ô∏è No puedes reservar en el pasado.");
                    if (fechaSeleccionada.getUTCDay() === 0) return alert("‚ö†Ô∏è Domingos no disponibles.");

                    const btn = event.target || event.currentTarget;
                    const originalText = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> PROCESANDO...';

                    try {
                        // Validar conflictos
                        const { error: conflictError } = await DataManager.checkConflicts(inst, fecha, hora);
                        if (conflictError) throw new Error(conflictError);

                        // Insertar
                        const { error } = await DataManager.addClass({
                            alumno_id: window.currentUserId,
                            instructor: inst,
                            fecha: fecha,
                            hora: hora,
                            notas: notas,
                            estado: 'CONFIRMADA'
                        });

                        if (error) throw error;

                        alert("‚úÖ Reserva Confirmada.");
                        document.getElementById('reservaFecha').value = '';
                        document.getElementById('reservaHora').value = '';
                        renderizarClases();
                        loadStudentData(); // Update next class widget

                    } catch (err) {
                        alert("‚ùå Error: " + err.message);
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                }

                // --- VIDEO HANDLER ---
                function toggleVideo(wrapper) {
                    const video = wrapper.querySelector('video');
                    const btn = wrapper.querySelector('.custom-play-btn');
                    if (!video) return;

                    if (video.paused) {
                        const playPromise = video.play();
                        if (playPromise !== undefined) {
                            playPromise.then(_ => {
                                video.controls = true;
                                if (btn) btn.style.display = 'none';
                            })
                                .catch(error => {
                                    console.error("Auto-play prevented:", error);
                                    alert("No se pudo reproducir el video autom√°ticamente. Por favor intenta de nuevo.");
                                });
                        }
                    }
                }

                // --- RESPONSIVE MENU TOGGLE ---
                function toggleDashboardMenu() {
                    const menu = document.getElementById('compactMenu');
                    const overlay = document.getElementById('sidebarOverlay');
                    const btn = document.querySelector('.dashboard-toggle');

                    if (menu) menu.classList.toggle('active');
                    if (overlay) overlay.classList.toggle('active');
                    if (btn) btn.classList.toggle('active');
                }

                async function renderizarClases() {
                    const lista = document.getElementById('listaClases');
                    if (!lista) return;

                    lista.innerHTML = '<div class="empty-state"><i class="fa-solid fa-circle-notch fa-spin"></i><p>Cargando agenda...</p></div>';

                    try {
                        const data = await DataManager.getClasses();

                        if (!data || data.length === 0) {
                            lista.innerHTML = `
                            <div class="empty-state">
                                <i class="fa-solid fa-calendar-xmark"></i>
                                <p>Sin clases agendadas</p>
                                <small>Usa el formulario para reservar tu primera pr√°ctica.</small>
                            </div>`;
                            return;
                        }

                        lista.innerHTML = data.map((r) => {
                            const fechaClase = new Date(`${r.fecha}T${r.hora}`);
                            const ahora = new Date();
                            const diffMs = fechaClase - ahora;
                            const diffHours = diffMs / (1000 * 60 * 60);
                            const bloqueada = diffHours < 8;

                            return `
                        <div class="agenda-item ${bloqueada ? 'locked' : ''}">
                            <div class="agenda-info w-100">
                                <span class="agenda-tag">${bloqueada ? 'üîí BLOQUEADO (MENOS DE 8H)' : '‚úÖ ACTIVA'}</span>
                                <span class="agenda-title"><i class="fa-solid fa-user-astronaut"></i> ${r.instructor}</span>
                                <div class="agenda-time">
                                    <span>üìÖ ${r.fecha}</span>
                                    <span>‚è∞ ${r.hora}</span>
                                </div>
                            </div>
                            <button onclick="eliminarClase('${r.id}', ${bloqueada})" 
                                    class="btn-delete" 
                                    title="${bloqueada ? 'No se puede cancelar (Regla 8h)' : 'Cancelar Clase'}"
                                    ${bloqueada ? 'disabled' : ''}>
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    `;
                        }).join('');
                    } catch (err) {
                        console.error("Error rendering:", err);
                        lista.innerHTML = `<p class="error-msg">Error cargando agenda: ${err.message}</p>`;
                    }
                }

                async function eliminarClase(id, bloqueada) {
                    if (bloqueada) {
                        alert("üö´ ACCESO DENEGADO\n\nNo puedes cancelar una clase con menos de 8 horas de anticipaci√≥n. Por favor contacta a administraci√≥n.");
                        return;
                    }
                    if (confirm("¬øEst√°s seguro de cancelar esta pr√°ctica?\nEsta acci√≥n liberar√° el horario para otros alumnos.")) {
                        try {
                            const { error } = await DataManager.cancelClass(id);
                            if (error) throw error;
                            alert("‚úÖ Clase cancelada exitosamente.");
                            renderizarClases();
                            loadStudentData(); // Update next class widget
                        } catch (err) {
                            alert("Error: " + err.message);
                        }
                    }
                }

                async function loadInstructorNotes() {
                    const container = document.getElementById('notasInstructor');
                    await new Promise(r => setTimeout(r, 500));

                    const notes = await DataManager.getNotes();

                    if (notes.length === 0) {
                        container.innerHTML = `
                        <div class="empty-state" style="padding: 20px;">
                            <i class="fa-solid fa-clipboard-check" style="font-size: 24px;"></i>
                            <p style="font-size: 14px;">Sin novedades</p>
                            <small>Tus instructores dejar√°n observaciones aqu√≠.</small>
                        </div>`;
                    } else {
                        container.innerHTML = notes.map(n => `
                        <div class="note-card">
                            <div class="note-header">
                                <span><i class="fa-solid fa-user-pen"></i> Feedback Instructor</span>
                                <span>${n.fecha}</span>
                            </div>
                            <p class="note-content">"${n.texto}"</p>
                        </div>
                    `).join('');
                    }
                }

                // --- L√ìGICA DE PROGRESO MATERIAL DE ESTUDIO ---
                function recalcProgress() {
                    const checkboxes = document.querySelectorAll('.progress-check');
                    const total = checkboxes.length;
                    let checked = 0;

                    checkboxes.forEach(c => {
                        if (c.checked) checked++;
                    });

                    const percent = Math.round((checked / total) * 100);
                    updateCircularProgress(percent);
                }

                // --- SISTEMA DE VIDEOTECA √âLITE (NUEVO) ---
                const DASHBOARD_VIDEOS = [
                    { id: "-LsosggkbjE", title: "Arrancar en Cuesta", category: "T√©cnica Maestra", desc: "Domina el arte del punto de fricci√≥n. En esta Masterclass, aprender√°s a coordinar embrague, acelerador y freno de mano para salidas impecables en pendientes pronunciadas sin retrocesos.", premium: false },
                    { id: "XEjvE7ABmfo", title: "Control de Embrague", category: "Dominio Total", desc: "El secreto de un conductor experto reside en su pierna izquierda. Descubre c√≥mo manejar la transici√≥n de potencia con suavidad quir√∫rgica para evitar tirones y proteger la vida √∫til de tu veh√≠culo.", premium: true },
                    { id: "k5-gdSK1PIs", title: "Maniobras de Reversa", category: "Precisi√≥n √âlite", desc: "La visi√≥n perif√©rica y el c√°lculo espacial son clave. Aprende el m√©todo de los 3 puntos para parquear en paralelo y reversar con la precisi√≥n de un piloto profesional.", premium: true },
                    { id: "__A2IMF091U", title: "Seguridad Vial", category: "Normativa 2024", desc: "Actualizaci√≥n integral sobre la Ley 2251 de 2022 (Ley Juli√°n Esteban). Repasamos l√≠mites de velocidad, prioridades en rotondas y las nuevas normativas que todo conductor √âlite debe conocer.", premium: true },
                    { id: "MyQKbmiVESo", title: "Mec√°nica de Emergencia", category: "Tips R√°pidos", desc: "No permitas que un imprevisto te detenga. Aprende a identificar ruidos cr√≠ticos, revisar niveles de fluidos esenciales y cambiar una llanta en tiempo r√©cord bajo condiciones adversas.", premium: true }
                ];

                function initDashboardVideos() {
                    const grid = document.getElementById('dashboard-video-grid');
                    if (!grid) return;
                    DASHBOARD_VIDEOS.forEach(vid => {
                        const item = document.createElement('div');
                        item.className = 'video-item';
                        item.innerHTML = `
                            <div class="video-thumb-container">
                                <img src="https://img.youtube.com/vi/${vid.id}/maxresdefault.jpg" alt="${vid.title}">
                                ${vid.premium ? '<div class="coming-soon-banner">PR√ìXIMAMENTE</div>' : ''}
                                <button class="info-btn-floating">(+) Ver Clase</button>
                            </div>
                            <div class="video-info">
                                <h4>${vid.title}</h4>
                                <div class="meta-row" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                                    <span class="duration" style="color: #c5a059; font-size: 0.8rem;">VIDEO √âLITE</span>
                                    <label class="custom-checkbox">
                                        <input type="checkbox" class="progress-check" onchange="recalcProgress()">
                                        <span class="checkmark"></span>
                                        Visto
                                    </label>
                                </div>
                            </div>
                        `;
                        item.onclick = () => openDashboardModal(vid);
                        grid.appendChild(item);
                    });
                }

                function openDashboardModal(vid) {
                    const modal = document.getElementById('dashboardModal');
                    const container = document.getElementById('dashboardModalVideoContainer');
                    const title = document.getElementById('dashboardModalTitle');
                    const desc = document.getElementById('dashboardModalDesc');

                    title.innerText = vid.title;
                    desc.innerText = vid.desc;

                    // BLINDAJE TOTAL (Error 153 FIX)
                    const videoUrl = `https://www.youtube-nocookie.com/embed/${vid.id}?rel=0&modestbranding=1&enablejsapi=1&origin=https://academia-elite.onrender.com&autoplay=1`;
                    container.innerHTML = `<iframe src="${videoUrl}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;

                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }

                document.getElementById('closeDashboardModal').onclick = () => {
                    const modal = document.getElementById('dashboardModal');
                    const container = document.getElementById('dashboardModalVideoContainer');
                    modal.classList.remove('active');
                    container.innerHTML = '';
                    document.body.style.overflow = '';
                };

                // Inicializar al cargar
                initDashboardVideos();
            </script>
    </body>

</html>