<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Élite | Academia de Conducción</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --gold: #c5a059; --dark: #050505; --card: rgba(255, 255, 255, 0.05); }
        body { background: radial-gradient(circle at center, #1a1a1a 0%, #050505 100%); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .dashboard-container { max-width: 1200px; margin: auto; }
        
        /* INDICADORES SUPERIORES */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: var(--card); border: 1px solid rgba(197, 160, 89, 0.2); padding: 20px; border-radius: 15px; text-align: center; backdrop-filter: blur(10px); }
        .stat-card h4 { color: var(--gold); margin: 0; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card p { font-size: 24px; font-weight: bold; margin: 10px 0 0 0; }

        .glass-section { background: var(--card); border-radius: 24px; padding: 25px; border: 1px solid rgba(197, 160, 89, 0.2); backdrop-filter: blur(10px); margin-bottom: 20px; }
        .main-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 25px; }

        /* CALENDARIO */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: var(--gold); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-name { font-size: 10px; color: var(--gold); font-weight: bold; padding-bottom: 10px; }
        .calendar-day { padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; cursor: pointer; transition: 0.3s; font-size: 13px; border: 1px solid transparent; }
        .calendar-day:hover:not(.disabled) { background: rgba(197, 160, 89, 0.2); border-color: var(--gold); }
        .calendar-day.selected { background: var(--gold); color: black; font-weight: bold; }
        .calendar-day.disabled { opacity: 0.2; cursor: not-allowed; }

        /* LICENCIA DIGITAL */
        .license-card { background: linear-gradient(135deg, #111, #050505); border: 2px solid var(--gold); border-radius: 20px; padding: 20px; border-left: 8px solid var(--gold); }
        .photo-container { position: relative; width: 130px; height: 130px; margin: 0 auto 15px; }
        .photo-frame { width: 100%; height: 100%; border: 3px solid var(--gold); border-radius: 12px; object-fit: cover; background: #111; }
        .upload-badge { position: absolute; bottom: -5px; right: -5px; background: var(--gold); color: black; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #050505; }
        
        /* FORMULARIO Y BOTONES */
        .select-cristal { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 10px; margin-bottom: 15px; box-sizing: border-box; }
        .btn-action { width: 100%; padding: 14px; background: var(--gold); border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: black; transition: 0.3s; }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(197, 160, 89, 0.4); }

        /* TRIVIA */
        .trivia-option { background: rgba(255,255,255,0.05); border: 1px solid #333; padding: 12px; border-radius: 10px; cursor: pointer; margin-bottom: 10px; transition: 0.3s; text-align: left; width: 100%; color: white; }
        .trivia-option:hover { border-color: var(--gold); background: rgba(197, 160, 89, 0.1); }

        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="dashboard-container">
    <div class="stats-grid">
        <div class="stat-card">
            <h4>Clases Completadas</h4>
            <p id="stat-clases">0 / 20</p>
        </div>
        <div class="stat-card">
            <h4>Puntaje Trivia</h4>
            <p id="stat-trivia">0%</p>
        </div>
        <div class="stat-card">
            <h4>Próxima Clase</h4>
            <p id="stat-proxima" style="font-size: 16px;">Sin agendar</p>
        </div>
    </div>

    <div class="main-grid">
        <div class="glass-section">
            <h3 style="color:var(--gold); margin-top:0"><i class="fas fa-calendar-alt"></i> AGENDA TU CLASE</h3>
            <div class="calendar-header">
                <button onclick="changeMonth(-1)" style="background:none; border:none; color:white; cursor:pointer;"><i class="fas fa-chevron-left"></i></button>
                <b id="monthDisplay"></b>
                <button onclick="changeMonth(1)" style="background:none; border:none; color:white; cursor:pointer;"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
            
            <div style="margin-top:20px;">
                <label style="font-size: 11px; color: var(--gold);">INSTRUCTOR</label>
                <select id="selectInstructor" class="select-cristal">
                    <option>Instructor Camilo (Moto)</option>
                    <option>Instructora Liliana (Moto)</option>
                </select>
                <button class="btn-action" onclick="agendarClase()">RESERVAR CLASE PRÁCTICA</button>
            </div>

            <div style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <h3 style="color:var(--gold);"><i class="fas fa-brain"></i> TRIVIA RÁPIDA</h3>
                <div id="trivia-box">
                    <p id="trivia-pregunta">¿Cuál es la distancia mínima para adelantar un ciclista?</p>
                    <button class="trivia-option" onclick="responderTrivia(100)">1.5 Metros</button>
                    <button class="trivia-option" onclick="responderTrivia(0)">0.5 Metros</button>
                </div>
            </div>
        </div>

        <div class="license-card">
            <h3 style="color: var(--gold); margin-top: 0; font-size: 14px; text-align: center; letter-spacing: 2px;">LICENCIA DIGITAL</h3>
            <center>
                <div class="photo-container">
                    <img id="currentAvatar" src="1.jpeg" class="photo-frame">
                    <label for="fileInput" class="upload-badge"><i class="fas fa-camera"></i></label>
                    <input type="file" id="fileInput" hidden accept="image/*" onchange="subirFoto(this)">
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                    <img src="1.jpeg" width="45" style="border-radius:5px; cursor:pointer; border: 1px solid #333;" onclick="setAvatar(this.src)">
                    <img src="3.jpeg" width="45" style="border-radius:5px; cursor:pointer; border: 1px solid #333;" onclick="setAvatar(this.src)">
                </div>
            </center>

            <label style="font-size: 9px; color: var(--gold); font-weight: bold;">NOMBRE COMPLETO</label>
            <input type="text" id="profName" class="select-cristal" placeholder="Tu nombre">
            
            <label style="font-size: 9px; color: var(--gold); font-weight: bold;">WHATSAPP</label>
            <input type="text" id="profWA" class="select-cristal" placeholder="+57">
            
            <button class="btn-action" onclick="guardarPerfil()">ACTUALIZAR DATOS <i class="fas fa-save"></i></button>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'TU_URL';
    const SUPABASE_KEY = 'TU_KEY';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { db: { schema: 'academia_elite' } });

    let currentDate = new Date();
    let selectedDateStr = null;

    // --- CARGAR DATOS INICIALES ---
    async function inicializarDashboard() {
        const { data: { user } } = await _supabase.auth.getUser();
        if (!user) return alert("Por favor, inicia sesión primero.");

        const { data: perfil } = await _supabase.from('alumnos').select('*').eq('id', user.id).single();
        if (perfil) {
            document.getElementById('profName').value = perfil.nombre_completo || '';
            document.getElementById('profWA').value = perfil.whatsapp || '';
            document.getElementById('currentAvatar').src = perfil.avatar_url || '1.jpeg';
            document.getElementById('stat-trivia').innerText = (perfil.puntaje_trivia || 0) + '%';
        }
        renderCalendar();
    }

    // --- CALENDARIO ---
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        const names = ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];
        names.forEach(n => grid.innerHTML += `<div class="day-name">${n}</div>`);

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        document.getElementById('monthDisplay').innerText = new Intl.DateTimeFormat('es-ES', { month: 'long', year: 'numeric' }).format(currentDate);

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const hoy = new Date(); hoy.setHours(0,0,0,0);

        for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';

        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dateObj = new Date(year, month, d);
            const isPast = dateObj < hoy;
            const isSun = dateObj.getDay() === 0;

            const dayEl = document.createElement('div');
            dayEl.className = `calendar-day ${isPast || isSun ? 'disabled' : ''} ${dateStr === selectedDateStr ? 'selected' : ''}`;
            dayEl.innerText = d;
            if(!isPast && !isSun) dayEl.onclick = () => { selectedDateStr = dateStr; renderCalendar(); };
            grid.appendChild(dayEl);
        }
    }

    function changeMonth(dir) { currentDate.setMonth(currentDate.getMonth() + dir); renderCalendar(); }
    function setAvatar(url) { document.getElementById('currentAvatar').src = url; }

    // --- FUNCIONES DE BASE DE DATOS ---
    async function subirFoto(input) {
        if (!input.files || input.files.length === 0) return;
        const file = input.files[0];
        const { data: { user } } = await _supabase.auth.getUser();
        const path = `avatars/${user.id}-${Date.now()}.${file.name.split('.').pop()}`;

        const { error } = await _supabase.storage.from('fotos_alumnos').upload(path, file);
        if (error) return alert("Error al subir imagen.");

        const { data: { publicUrl } } = _supabase.storage.from('fotos_alumnos').getPublicUrl(path);
        document.getElementById('currentAvatar').src = publicUrl;
    }

    async function guardarPerfil() {
        const { data: { user } } = await _supabase.auth.getUser();
        const { error } = await _supabase.from('alumnos').upsert({
            id: user.id,
            nombre_completo: document.getElementById('profName').value,
            whatsapp: document.getElementById('profWA').value,
            avatar_url: document.getElementById('currentAvatar').src
        });
        if(!error) alert("✅ Perfil guardado con éxito.");
    }

    async function responderTrivia(puntos) {
        const { data: { user } } = await _supabase.auth.getUser();
        await _supabase.from('alumnos').update({ puntaje_trivia: puntos }).eq('id', user.id);
        document.getElementById('stat-trivia').innerText = puntos + '%';
        alert(puntos > 0 ? "¡Correcto! +100 pts" : "Incorrecto. ¡Sigue estudiando!");
    }

    async function agendarClase() {
        if(!selectedDateStr) return alert("Selecciona una fecha.");
        const { data: { user } } = await _supabase.auth.getUser();
        const { error } = await _supabase.from('reservas_clases').insert([{
            alumno_id: user.id,
            instructor: document.getElementById('selectInstructor').value,
            fecha_hora: `${selectedDateStr}T08:00:00`
        }]);
        if(!error) alert("✅ Clase agendada exitosamente.");
    }

    inicializarDashboard();
</script>
</body>
</html>