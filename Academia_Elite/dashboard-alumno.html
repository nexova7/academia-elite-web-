<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard √âlite | Academia de Conducci√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --gold: #c5a059; --dark: #050505; --card: rgba(255, 255, 255, 0.05); }
        
        body { 
            background: radial-gradient(circle at center, #1a1a1a 0%, #050505 100%); 
            color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px;
        }

        .dashboard-container { max-width: 1100px; margin: auto; padding-bottom: 50px; }

        /* 1. DASHBOARD HOME - STATS & PROGRESS */
        .welcome-banner { 
            padding: 30px; border-radius: 24px; border: 1px solid rgba(197, 160, 89, 0.3);
            background: linear-gradient(135deg, rgba(197, 160, 89, 0.1), transparent);
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;
        }

        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 25px; }
        .stat-glass { 
            background: var(--card); backdrop-filter: blur(10px); padding: 20px; 
            border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); text-align: center;
        }

        .progress-circle-container { position: relative; width: 120px; height: 120px; }
        .progress-svg { transform: rotate(-90deg); width: 120px; height: 120px; }
        .progress-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 10; }
        .progress-bar { fill: none; stroke: var(--gold); stroke-width: 10; stroke-linecap: round; stroke-dasharray: 314; stroke-dashoffset: 314; transition: 1s; }

        /* 2. PERFIL ESTILO LICENCIA */
        .license-card {
            background: linear-gradient(135deg, #111, #050505); border: 2px solid var(--gold);
            border-radius: 20px; padding: 25px; position: relative; overflow: hidden; margin-top: 30px;
        }
        .license-card::after {
            content: "ELITE ACADEMY SECURITY"; position: absolute; opacity: 0.02; font-size: 8px;
            width: 200%; height: 200%; top: -50%; left: -50%; transform: rotate(-15deg); pointer-events: none;
        }
        .avatar-picker img { width: 45px; height: 45px; cursor: pointer; border: 1px solid #333; border-radius: 5px; margin: 2px; transition: 0.3s; }
        .avatar-picker img:hover { border-color: var(--gold); transform: scale(1.1); }

        /* 3, 4, 5. SECCIONES GLASS & NETFLIX */
        .glass-section {
            background: var(--card); border-radius: 24px; padding: 30px; margin-top: 30px;
            border: 1px solid rgba(197, 160, 89, 0.2); backdrop-filter: blur(10px);
        }

        .btn-glass {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(197, 160, 89, 0.4);
            padding: 15px 30px; border-radius: 50px; color: var(--gold); font-weight: bold;
            backdrop-filter: blur(15px); cursor: pointer; text-decoration: none; display: inline-block;
        }

        .medal-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 20px; }
        .medal { opacity: 0.15; filter: grayscale(1); text-align: center; transition: 0.5s; }
        .medal.active { opacity: 1; filter: grayscale(0); color: var(--gold); transform: scale(1.1); }

        .netflix-row { display: flex; gap: 15px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; }
        .video-card { 
            min-width: 180px; height: 100px; background: #1a1a1a; border-radius: 10px; 
            border: 1px solid #333; display: flex; align-items: center; justify-content: center; position: relative;
        }
        .video-card i { font-size: 24px; color: var(--gold); transition: 0.3s; }
        .video-card:hover i { transform: scale(1.3); text-shadow: 0 0 10px var(--gold); }

        .select-cristal { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; }
        .btn-action { width: 100%; padding: 14px; background: var(--gold); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: black; }
        .clase-card { background: rgba(255,255,255,0.03); border-left: 4px solid var(--gold); padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Bot√≥n Cancelar Deshabilitado */
        .btn-cancelar { background: rgba(220, 53, 69, 0.2); color: #ff4d4d; border: 1px solid #dc3545; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .btn-cancelar:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(1); border-color: #555; color: #888; }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <div class="welcome-banner">
            <div>
                <h1 id="userName">Cargando...</h1>
                <p style="opacity: 0.7;">Tu camino a la licencia profesional comienza aqu√≠.</p>
            </div>
            <div class="progress-circle-container">
                <svg class="progress-svg">
                    <circle class="progress-bg" cx="60" cy="60" r="50"></circle>
                    <circle id="progresoCircular" class="progress-bar" cx="60" cy="60" r="50"></circle>
                </svg>
                <div style="position: absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size: 14px; font-weight: bold;" id="progresoTexto">0%</div>
            </div>
        </div>

        <div class="stats-row">
            <div class="stat-glass">
                <label style="font-size: 10px; color: var(--gold);">CLASES COMPLETADAS</label>
                <h2 id="clasesCount">0 / 20</h2>
            </div>
            <div class="stat-glass">
                <label style="font-size: 10px; color: var(--gold);">PUNTAJE TRIVIA</label>
                <h2 id="triviaScore">0%</h2>
            </div>
            <div class="stat-glass">
                <label style="font-size: 10px; color: var(--gold);">PR√ìXIMA CLASE</label>
                <h2 id="nextClassDate" style="font-size: 16px;">Sin agendar</h2>
            </div>
        </div>

        <div class="license-card">
            <h3 style="color: var(--gold); margin-top: 0; font-size: 14px;">LICENCIA DE CONDUCCI√ìN DIGITAL</h3>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="text-align: center;">
                    <img id="currentAvatar" src="https://api.dicebear.com/7.x/pixel-art/svg?seed=Felix" style="width: 120px; height: 140px; border: 2px solid var(--gold); border-radius: 10px;">
                    <div class="avatar-picker" style="margin-top: 10px;">
                        <img src="https://api.dicebear.com/7.x/pixel-art/svg?seed=Jack" onclick="setAvatar(this.src)">
                        <img src="https://api.dicebear.com/7.x/pixel-art/svg?seed=Sara" onclick="setAvatar(this.src)">
                        <img src="https://api.dicebear.com/7.x/pixel-art/svg?seed=Biker" onclick="setAvatar(this.src)">
                    </div>
                </div>
                <div style="flex: 1; min-width: 280px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="grid-column: span 2;"><label style="font-size: 10px; color: var(--gold);">NOMBRE COMPLETO</label><input type="text" id="profName" class="select-cristal"></div>
                    <div><label style="font-size: 10px; color: var(--gold);">WHATSAPP</label><input type="text" id="profWA" class="select-cristal"></div>
                    <div><label style="font-size: 10px; color: var(--gold);">EMAIL</label><input type="text" id="profEmail" class="select-cristal" readonly></div>
                    <div><label style="font-size: 10px; color: var(--gold);">NUEVA CLAVE</label><input type="password" id="newPass" class="select-cristal" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                    <div><label style="font-size: 10px; color: var(--gold);">CONFIRMAR</label><input type="password" id="confirmPass" class="select-cristal" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                    <button class="btn-action" style="grid-column: span 2;" onclick="guardarCambiosPerfil()">GUARDAR CAMBIOS üíæ</button>
                </div>
            </div>
        </div>

        <div class="glass-section">
            <h2 style="color: var(--gold); font-size: 18px;">MIS CLASES PR√ÅCTICAS</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 20px;">
                <select id="selectInstructor" class="select-cristal">
                    <option value="Instructora Liliana">Instructora Liliana</option>
                    <option value="Instructor Camilo">Instructor Camilo</option>
                </select>
                <input type="date" id="fechaClase" class="select-cristal">
                <select id="horaClase" class="select-cristal">
                    <option value="08:00">08:00 AM</option>
                    <option value="10:00">10:00 AM</option>
                    <option value="14:00">02:00 PM</option>
                    <option value="16:00">04:00 PM</option>
                </select>
                <button class="btn-action" onclick="agendarClase()">RESERVAR TURNO</button>
            </div>
            <div id="listaClases"></div>
        </div>

        <div class="glass-section" style="text-align: center;">
            <h2 style="color: var(--gold);">TRIVIA √âLITE</h2>
            <p style="font-size: 12px; opacity: 0.6;">Racha: <span id="rachaDias" style="color: var(--gold);">0 D√≠as üî•</span></p>
            <a href="evaluacion.html" class="btn-glass" style="margin: 20px 0;">INICIAR ENTRENAMIENTO</a>
            <div class="medal-grid">
                <div class="medal" id="medal1"><i class="fas fa-trophy"></i><p>Perfecto</p></div>
                <div class="medal" id="medal2"><i class="fas fa-bolt"></i><p>R√°pido</p></div>
                <div class="medal" id="medal3"><i class="fas fa-fire"></i><p>Racha 7</p></div>
                <div class="medal" id="medal4"><i class="fas fa-shield-alt"></i><p>Invicto</p></div>
                <div class="medal" id="medal5"><i class="fas fa-star"></i><p>√âlite</p></div>
                <div class="medal" id="medal6"><i class="fas fa-graduation-cap"></i><p>Final</p></div>
            </div>
        </div>

        <div class="glass-section">
            <h2 style="color: var(--gold); font-size: 18px;">VIDEOTECA √âLITE</h2>
            <div class="netflix-row">
                <div>
                    <div class="video-card"><i class="fas fa-play"></i></div>
                    <label style="font-size: 10px;"><input type="checkbox" onchange="actualizarProgreso()"> Normas de Tr√°nsito</label>
                </div>
                <div>
                    <div class="video-card"><i class="fas fa-play"></i></div>
                    <label style="font-size: 10px;"><input type="checkbox" onchange="actualizarProgreso()"> Mec√°nica B√°sica</label>
                </div>
                <div>
                    <div class="video-card"><i class="fas fa-play"></i></div>
                    <label style="font-size: 10px;"><input type="checkbox" onchange="actualizarProgreso()"> Primeros Auxilios</label>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://aldwcqpgsjfjcttxfecp.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_OvQYw50Cs8sM21AJGg21zg_v3LunT3J';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            db: { schema: 'academia_elite' }
        });

        function setAvatar(url) { document.getElementById('currentAvatar').src = url; }

        async function cargarDatosEstudiante() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) { window.location.href = "acceso-alumnos.html"; return; }

            const { data: alumno } = await _supabase.from('alumnos').select('*').eq('id', user.id).single();

            if (alumno) {
                document.getElementById('userName').innerText = `¬°Bienvenido, ${alumno.nombre_completo.split(' ')[0]}!`;
                document.getElementById('profName').value = alumno.nombre_completo;
                document.getElementById('profEmail').value = alumno.email;
                document.getElementById('profWA').value = alumno.whatsapp || "";
                document.getElementById('triviaScore').innerText = (alumno.puntaje_trivia || 0) + "%";
                document.getElementById('rachaDias').innerText = (alumno.racha || 0) + " D√≠as üî•";
                if(alumno.avatar_url) document.getElementById('currentAvatar').src = alumno.avatar_url;
                
                if(alumno.puntaje_trivia >= 100) document.getElementById('medal1').classList.add('active');
                if(alumno.racha >= 7) document.getElementById('medal3').classList.add('active');

                const totalClases = 20;
                const realizadas = alumno.clases_realizadas || 0;
                const porcentaje = (realizadas / totalClases) * 100;
                document.getElementById('progresoTexto').innerText = Math.round(porcentaje) + "%";
                document.getElementById('progresoCircular').style.strokeDashoffset = 314 - (314 * porcentaje / 100);
                document.getElementById('clasesCount').innerText = `${realizadas} / ${totalClases}`;
            }
            cargarClases(user.id);
        }

        async function guardarCambiosPerfil() {
            const { data: { user } } = await _supabase.auth.getUser();
            const p1 = document.getElementById('newPass').value;
            const p2 = document.getElementById('confirmPass').value;

            if (p1 !== "" && p1 !== p2) return alert("‚ùå Las contrase√±as no coinciden.");
            if (p1 !== "") await _supabase.auth.updateUser({ password: p1 });

            const { error } = await _supabase.from('alumnos').update({ 
                nombre_completo: document.getElementById('profName').value,
                whatsapp: document.getElementById('profWA').value,
                avatar_url: document.getElementById('currentAvatar').src
            }).eq('id', user.id);

            if (error) alert("Error: " + error.message);
            else alert("‚úÖ Perfil de Conductor Actualizado.");
        }

        async function agendarClase() {
            const { data: { user } } = await _supabase.auth.getUser();
            const fecha = document.getElementById('fechaClase').value;
            if(!fecha) return alert("Selecciona fecha");
            
            const hoy = new Date().toISOString().split('T')[0];
            if(fecha < hoy) return alert("‚ùå No puedes agendar fechas pasadas.");

            const dia = new Date(fecha).getUTCDay();
            if(dia === 0) return alert("‚ùå No hay clases los domingos.");

            await _supabase.from('reservas_clases').insert([{ 
                alumno_id: user.id, 
                instructor: document.getElementById('selectInstructor').value,
                fecha_hora: `${fecha}T${document.getElementById('horaClase').value}:00`
            }]);
            cargarClases(user.id);
        }

        async function cargarClases(userId) {
            const { data: clases } = await _supabase.from('reservas_clases').select('*').eq('alumno_id', userId).order('fecha_hora');
            const lista = document.getElementById('listaClases');
            lista.innerHTML = '';
            
            if(clases?.length > 0) {
                document.getElementById('nextClassDate').innerText = new Date(clases[0].fecha_hora).toLocaleDateString();
                clases.forEach(c => {
                    const diff = (new Date(c.fecha_hora) - new Date()) / 3600000;
                    lista.innerHTML += `
                        <div class="clase-card">
                            <div><b>${c.instructor}</b><br><small>${new Date(c.fecha_hora).toLocaleString()}</small></div>
                            <button class="btn-cancelar" ${diff < 8 ? 'disabled' : ''} onclick="cancelar('${c.id}')">
                                ${diff < 8 ? '<i class="fas fa-lock"></i> Bloqueado' : 'Cancelar'}
                            </button>
                        </div>`;
                });
            }
        }

        async function cancelar(id) {
            if(confirm("¬øSeguro que deseas liberar este turno?")) {
                await _supabase.from('reservas_clases').delete().eq('id', id);
                cargarDatosEstudiante();
            }
        }

        function actualizarProgreso() { console.log("Progreso de video guardado."); }

        cargarDatosEstudiante();
    </script>
</body>
</html>